import os
from host import Host
import zipfile
import datetime
from paramiko import SSHClient
from scp import SCPClient




class Backup():

	def __init__(self, host_obj):
		self.backup_files = []
		self.nb_files = 0
		self.backup_path  = "/home/pi/shared"
		self.getFiles()
		self.backupFiles()

	def getFiles(self):
		with open('config/backup_extensions.txt', 'r') as backup_extensions_file :
			tmp = backup_extensions_file.read()
		backup_extensions_file.close()
		backup_extensions = tmp.split(":")
		for dirpath, dirnames, files in os.walk(self.backup_path):
			for file in files :
				if file.endswith(tuple(backup_extensions)) :
					self.backup_files.append(os.path.join(dirpath, file))
					self.nb_files += 1

	def backupFiles(self):
		backup_log = open("logs/backup.log", "a+")
		zip_name = "Backup_"+datetime.datetime.now().strftime('%d-%m-%Y_%H:%M:%S')
		with zipfile.ZipFile("backups/"+zip_name, 'w') as zipMe :
			for file in self.backup_files :
				backup_log.write("%s ADDING %s\n" % (datetime.datetime.now().strftime('%d-%m-%Y_%H:%M:%S'), file))
				zipMe.write(file, compress_type=zipfile.ZIP_BZIP2)
				self.nb_files -= 1
			backup_log.write("%s Backup has finished with success as %s\n" % (datetime.datetime.now().strftime('%d-%m-%Y_%H:%M:%S'), zip_name))



		
		







